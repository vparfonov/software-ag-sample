<!--

     [2012] - [2017] Codenvy, S.A.
     All Rights Reserved.

    NOTICE:  All information contained herein is, and remains
    the property of Codenvy S.A. and its suppliers,
    if any.  The intellectual and technical concepts contained
    herein are proprietary to Codenvy S.A.
    and its suppliers and may be covered by U.S. and Foreign Patents,
    patents in process, and are protected by trade secret or copyright law.
    Dissemination of this information or reproduction of this material
    is strictly forbidden unless prior written permission is obtained
    from Codenvy S.A..

-->
<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" type="text/css" href="factory.css">
</head>

<script type="text/javascript">

var FactoryButton = new function() {

    /*
     * Determines whether string conteins substring.
     */
    if (!String.prototype.contains) {
        String.prototype.contains = function (substring) {
            return this.indexOf(substring) >= 0;
        }
    }


    var factoryID, uID;

    var style;

    var counter;

    var logoURL;

    var clickURL;

    var acceptedElement, acceptedURL;


    /*
     * Returns value of named query parameter.
     */
    this.getQueryParam = function(param) {
        var search = window.location.search.substring(1);
        var array = search.split('&');
        for(var i = 0; i < array.length; i++) {
            var pair = array[i].split('=');
            if(pair[0] == param){
                return pair[1];
            }
        }
    };


    /*
     * Sends a message to parent frame with with request to change size of a button.
     */
    this.resize = function(width, height) {
        if (FactoryButton.factoryID && FactoryButton.uID) {
            var message = "resize-factory-button:" + FactoryButton.factoryID + ":" + FactoryButton.uID + ":" + width + ":" + height;
            setTimeout(function() {
                parent.postMessage(message, "*");
            }, 10);
        }
    };


    /*
     * Handles mouse clicking on the button.
     */
    this.clickHandler = function() {
        if (FactoryButton.clickURL) {
            window.open(FactoryButton.clickURL, "_blank");
        }
    };


    /*
     * <div class="codenow-white"></div>
     */
    this.embedWhite = function() {
        var _embed = document.createElement("div");
        _embed.classList.add("codenow-white");
        _embed.onclick = FactoryButton.clickHandler;
        document.body.appendChild(_embed);

        FactoryButton.resize(77, 21);
    };


    /*
     * <div class="codenow-dark"></div>
     */
    this.embedDark = function() {
        var _embed = document.createElement("div");
        _embed.classList.add("codenow-dark");
        _embed.onclick = FactoryButton.clickHandler;
        document.body.appendChild(_embed);

        FactoryButton.resize(77, 21);
    };


    /*
     * <div class="codenow-horizontal">
     *    <div class="codenow-white codenow-bottom"></div>
     *    <div class="codenow-counter-horizontal"><span>333</span></div>
     * </div>
     */
    this.embedHorizontalWhite = function() {
        var _embed = document.createElement("div");
        _embed.classList.add("codenow-horizontal");
        document.body.appendChild(_embed);

        var _button = document.createElement("div");
        _button.classList.add("codenow-white");
        _button.classList.add("codenow-bottom");
        _button.onclick = FactoryButton.clickHandler;
        _embed.appendChild(_button);

        var _counter = document.createElement("div");
        _counter.classList.add("codenow-counter-horizontal");
        _embed.appendChild(_counter);

        FactoryButton.acceptedElement = document.createElement("span");
        FactoryButton.acceptedElement.innerHTML = "...";
        _counter.appendChild(FactoryButton.acceptedElement);

        FactoryButton.resize(118, 21);
    }


    /*
     * <div class="codenow-horizontal">
     *    <div class="codenow-dark codenow-bottom"></div>
     *    <div class="codenow-counter-horizontal"><span>333</span></div>
     * </div>
     */
    this.embedHorizontalDark = function() {
        var _embed = document.createElement("div");
        _embed.classList.add("codenow-horizontal");
        document.body.appendChild(_embed);

        var _button = document.createElement("div");
        _button.classList.add("codenow-dark");
        _button.classList.add("codenow-bottom");
        _button.onclick = FactoryButton.clickHandler;
        _embed.appendChild(_button);

        var _counter = document.createElement("div");
        _counter.classList.add("codenow-counter-horizontal");
        _embed.appendChild(_counter);

        FactoryButton.acceptedElement = document.createElement("span");
        FactoryButton.acceptedElement.innerHTML = "...";
        _counter.appendChild(FactoryButton.acceptedElement);

        FactoryButton.resize(118, 21);
    }


    /*
     * <div class="codenow-vertical">
     *    <div class="codenow-counter-vertical"><span>333</span></div>
     *    <div class="codenow-white codenow-bottom"></div>
     * </div>
     */
    this.embedVerticalWhite = function() {
        var _embed = document.createElement("div");
        _embed.classList.add("codenow-vertical");
        document.body.appendChild(_embed);

        var _counter = document.createElement("div");
        _counter.classList.add("codenow-counter-vertical");
        _embed.appendChild(_counter);

        FactoryButton.acceptedElement = document.createElement("span");
        FactoryButton.acceptedElement.innerHTML = "...";
        _counter.appendChild(FactoryButton.acceptedElement);

        var _button = document.createElement("div");
        _button.classList.add("codenow-white");
        _button.classList.add("codenow-bottom");
        _button.onclick = FactoryButton.clickHandler;
        _embed.appendChild(_button);

        FactoryButton.resize(77, 61);
    }


    /*
     * <div class="codenow-vertical">
     *    <div class="codenow-counter-vertical"><span>333</span></div>
     *    <div class="codenow-dark codenow-bottom"></div>
     * </div>
     */
    this.embedVerticalDark = function() {
        var _embed = document.createElement("div");
        _embed.classList.add("codenow-vertical");
        document.body.appendChild(_embed);

        var _counter = document.createElement("div");
        _counter.classList.add("codenow-counter-vertical");
        _embed.appendChild(_counter);

        FactoryButton.acceptedElement = document.createElement("span");
        FactoryButton.acceptedElement.innerHTML = "...";
        _counter.appendChild(FactoryButton.acceptedElement);

        var _button = document.createElement("div");
        _button.classList.add("codenow-dark");
        _button.classList.add("codenow-bottom");
        _button.onclick = FactoryButton.clickHandler;
        _embed.appendChild(_button);

        FactoryButton.resize(77, 61);
    }


    /*
     * <div class="advanced-factory">
     *    <img alt="" src="..." />
     *    <a></a>
     *    <div></div>
     * </div>
     */
    this.embedAdvanced = function() {
        var _embed = document.createElement("div");
        _embed.classList.add("advanced-factory");
        document.body.appendChild(_embed);

        var _logoImage = document.createElement("img");
        if (FactoryButton.logoURL) {
            _logoImage.style.opacity = 0;
            _logoImage.src = FactoryButton.logoURL;
        } else {
            _logoImage.classList.add("advanced-factory-no-logo-available");
        }

        _logoImage.onload = function(e) {
            e.target.style.opacity = 1;
        };

        _logoImage.onabort = _logoImage.onerror = function(e) {
            e.target.style.opacity = 1;
            e.target.classList.add("advanced-factory-no-logo-available");
        };

        _embed.appendChild(_logoImage);

        var _border = document.createElement("a");
        _embed.appendChild(_border);

        var _button = document.createElement("div");
        _button.onclick = FactoryButton.clickHandler;
        _embed.appendChild(_button);

        FactoryButton.resize(112, 113);
    }

    /*
     * <div class="advanced-factory-noted">
     *    <img alt="" src="..." />
     *    <a></a>
     *    <div></div>
     *    <span>33</span>
     * </div>
     */
    this.embedAdvancedWithCounter = function() {
        var _embed = document.createElement("div");
        _embed.classList.add("advanced-factory-noted");
        document.body.appendChild(_embed);

        var _logoImage = document.createElement("img");
        if (FactoryButton.logoURL) {
            _logoImage.style.opacity = 0;
            _logoImage.src = FactoryButton.logoURL;
        } else {
            _logoImage.classList.add("advanced-factory-no-logo-available");
        }

        _logoImage.onload = function(e) {
            e.target.style.opacity = 1;
        }

        _logoImage.onabort = _logoImage.onerror = function(e) {
            e.target.style.opacity = 1;
            e.target.classList.add("advanced-factory-no-logo-available");
        }

        _embed.appendChild(_logoImage);

        var _border = document.createElement("a");
        _embed.appendChild(_border);

        var _button = document.createElement("div");
        _button.onclick = FactoryButton.clickHandler;
        _embed.appendChild(_button);

        FactoryButton.acceptedElement = document.createElement("span");
        FactoryButton.acceptedElement.innerHTML = "...";
        _embed.appendChild(FactoryButton.acceptedElement);

        FactoryButton.resize(112, 113);
    }


    /*
     * Embeds factory button.
     */
    this.embed = function() {
        if (!FactoryButton.style) {
            return;
        }

        var style = FactoryButton.style.toLowerCase();

        if ("gray" == style) {
            if (FactoryButton.counter) {
                if ("vertical" == FactoryButton.counter) {
                    FactoryButton.embedVerticalDark();
                } else if ("horizontal" == FactoryButton.counter) {
                    FactoryButton.embedHorizontalDark();
                } else {
                    FactoryButton.embedDark();
                }
            } else {
                FactoryButton.embedDark();
            }
        } else if ("white" == style) {
            if (FactoryButton.counter) {
                if ("vertical" == FactoryButton.counter) {
                    FactoryButton.embedVerticalWhite();
                } else if ("horizontal" == FactoryButton.counter) {
                    FactoryButton.embedHorizontalWhite();
                } else {
                    FactoryButton.embedWhite();
                }
            } else {
                FactoryButton.embedWhite();
            }
        } else if ("white" == style) {
            if (FactoryButton.counter) {
                if ("vertical" == FactoryButton.counter) {
                    FactoryButton.embedVerticalWhite();
                } else if ("horizontal" == FactoryButton.counter) {
                    FactoryButton.embedHorizontalWhite();
                } else {
                    FactoryButton.embedWhite();
                }
            } else {
                FactoryButton.embedWhite();
            }
        } else if ("advanced" == style) {
            if (FactoryButton.counter) {
                if ("horizontal" == FactoryButton.counter || "vertical" == FactoryButton.counter) {
                    FactoryButton.embedAdvancedWithCounter();
                } else {
                    FactoryButton.embedAdvanced();
                }
            } else {
                FactoryButton.embedAdvanced();
            }
        } else {
            // Following verifications are needed to be compatible with old factories.
            if (style.contains("advanced")) {
                if (style.contains("counter")) {
                    FactoryButton.embedAdvancedWithCounter();
                } else {
                    FactoryButton.embedAdvanced();
                }
            } else if (style.contains("horizontal")) {
                if (style.contains("white")) {
                    FactoryButton.embedHorizontalWhite();
                } else {
                    FactoryButton.embedHorizontalDark();
                }
            } else if (style.contains("vertical")) {
                if (style.contains("white")) {
                    FactoryButton.embedVerticalWhite();
                } else {
                    FactoryButton.embedVerticalDark();
                }
            } else if (style.contains("white")) {
                FactoryButton.embedWhite();
            } else if (style.contains("dark")) {
                FactoryButton.embedDark();
            }
        }

        FactoryButton.showCreatedProjects();
    };


    /*
     * Loads and displays the number of created projects.
     */
    this.showCreatedProjects = function() {
        try {
            if (!FactoryButton.acceptedURL || !FactoryButton.acceptedElement) {
                return;
            }

            var request = new XMLHttpRequest();
            request.onreadystatechange  = function() {
                if (request.readyState == 4 && request.status == 200) {
                    try {
                        var value = JSON.parse(request.responseText).value;
                        var digMask=/^\d+$/;
                        if (digMask.test(value)) {
                            FactoryButton.acceptedElement.innerHTML = value;
                        } else {
                            FactoryButton.acceptedElement.innerHTML = "?";
                        }
                    } catch (e) {
                        console.log(e.message);
                    }
                }
            }

            request.open("GET", FactoryButton.acceptedURL, true);
            request.send();

            setTimeout(FactoryButton.showCreatedProjects, 30000);
        } catch (e) {
            console.log(e.message);
        }
    }


    /*
     * Checks page parameters and displays a Factory button.
     */
    this.go = function() {
        FactoryButton.factoryID = FactoryButton.getQueryParam("factory");
        FactoryButton.uID = FactoryButton.getQueryParam("uid");

        FactoryButton.style = FactoryButton.getQueryParam("style");
        if (FactoryButton.style) {
            FactoryButton.style = decodeURIComponent(FactoryButton.style);
        }

        FactoryButton.counter = FactoryButton.getQueryParam("counter");
        if (FactoryButton.counter) {
            FactoryButton.counter = decodeURIComponent(FactoryButton.counter);
        }

        FactoryButton.clickURL = FactoryButton.getQueryParam("url");
        if (FactoryButton.clickURL) {
            FactoryButton.clickURL = decodeURIComponent(FactoryButton.clickURL);
        }

        FactoryButton.logoURL = FactoryButton.getQueryParam("logo");
        if (FactoryButton.logoURL) {
            FactoryButton.logoURL = decodeURIComponent(FactoryButton.logoURL);
        }

        if (FactoryButton.factoryID) {
            FactoryButton.loadFactoryJSON();
        } else {
            FactoryButton.embed();
        }
    };


    /*
     * Returns link value by relation.
     */
    this.getRelatedLink = function(json, rel) {
        for (i = 0; i < json.links.length; i++) {
            var linkObj = json.links[i];
            if (linkObj.rel == rel) {
                return linkObj.href;
            }
        }

        return null;
    }


    /*
     * Loads Factory JSON and fetches Factory button parameters.
     */
    this.loadFactoryJSON = function() {
        try {
            var url = window.location.protocol + "//" + window.location.host + "/api/factory/" + FactoryButton.factoryID;
            var request = new XMLHttpRequest();

            request.onreadystatechange  = function() {
                if (request.readyState == 4) {
                    if (request.status == 200) {
                        var json = JSON.parse(request.responseText);

                        if (json.button) { /* Factory 2.0 */
                            FactoryButton.clickURL = FactoryButton.getRelatedLink(json, "create-project");
                            FactoryButton.acceptedURL = FactoryButton.getRelatedLink(json, "accepted");

                            if (!FactoryButton.style) {
                                if (json.button.type == "logo") { /* type = logo */
                                    if (true == json.button.attributes.counter) {
                                        FactoryButton.style = "advanced,counter";
                                    } else {
                                        FactoryButton.style = "advanced";
                                    }
                                } else if (json.button.type == "nologo") { /* type = nologo */
                                    if (true == json.button.attributes.counter) { /* nologo with counter */
                                        if (json.button.attributes.style == "horizontal") { /* nologo, with counter, horizontal */
                                            if (json.button.attributes.color == "white") {
                                                FactoryButton.style = "horizontal,white";
                                            } else if (json.button.attributes.color == "gray") {
                                                FactoryButton.style = "horizontal,dark";
                                            }
                                        } else if (json.button.attributes.style == "vertical") { /* nologo, with counter, vertical */
                                            if (json.button.attributes.color == "white") {
                                                FactoryButton.style = "vertical,white";
                                            } else if (json.button.attributes.color == "gray") {
                                                FactoryButton.style = "vertical,dark";
                                            }
                                        }
                                    } else { /* nologo without counter */
                                        if (json.button.attributes.color == "white") {
                                            FactoryButton.style = "white";
                                        } else if (json.button.attributes.color == "gray") {
                                            FactoryButton.style = "dark";
                                        }
                                    }
                                }
                            }

                            if (!FactoryButton.logoURL && json.button.attributes.logo && json.button.attributes.logo.trim()) {
                                FactoryButton.logoURL = json.button.attributes.logo.trim();
                            }

                        } else { /* Earlier versions of Factory */
                            if (!FactoryButton.style) {
                                FactoryButton.style = json.style;
                            }

                            if (!FactoryButton.logoURL) {
                                FactoryButton.logoURL = FactoryButton.getRelatedLink(json, "image");
                            }

                            FactoryButton.clickURL = FactoryButton.getRelatedLink(json, "create-project");
                            FactoryButton.acceptedURL = FactoryButton.getRelatedLink(json, "accepted");
                        }
                    }

                    FactoryButton.embed();
                }
            };

            request.open("GET", url, true);
            request.send();
        } catch (e) {
            console.log("Unable to get Factory JSON. " + e.message);
        }
    };

};
</script>


<body style="padding:0; margin:0; background:transparent;" onload="FactoryButton.go();"></body>
</html>
